From: Timo Sirainen <tss@iki.fi>
Date: Sat, 21 May 2011 19:52:37 +0200
Subject: [PATCH] CVE-2011-1929

Description:
 Fixed handling NUL characters in header names. line->name_len was too
 large and line->middle pointer may have pointed past allocated memory.
 These may have caused crashes/corruption (fts, mbox at least).
 (CVE-2011-1929)
Origin: upstream, http://hg.dovecot.org/dovecot-1.2/rev/ede60b230594
Bug-Debian: http://bugs.debian.org/627443

---
 src/lib-mail/message-header-parser.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/src/lib-mail/message-header-parser.c b/src/lib-mail/message-header-parser.c
index d75db96..86e9915 100644
--- a/src/lib-mail/message-header-parser.c
+++ b/src/lib-mail/message-header-parser.c
@@ -311,7 +311,9 @@ int message_parse_header_next(struct message_header_parser_ctx *ctx,
 			colon_pos--;
 
 		str_truncate(ctx->name, 0);
-		str_append_n(ctx->name, msg, colon_pos);
+		/* use buffer_append() so the name won't be truncated if there
+		   are NULs. */
+		buffer_append(ctx->name, msg, colon_pos);
 		str_append_c(ctx->name, '\0');
 
 		/* keep middle stored also in ctx->name so it's available
-- 
