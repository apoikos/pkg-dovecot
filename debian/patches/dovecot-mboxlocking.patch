Author: Joel Johnson <mrjoel@lixil.net>
Description: Change default Debian value in accordance with Debian Policy

--- dovecot-1.2.7.orig/dovecot-example.conf
+++ dovecot-1.2.7/dovecot-example.conf
@@ -488,8 +488,14 @@
 # in is important to avoid deadlocks if other MTAs/MUAs are using multiple
 # locking methods as well. Some operating systems don't allow using some of
 # them simultaneously.
+#
+# The Debian value for mbox_write_locks differs from upstream Dovecot. It is
+# changed to be compliant with Debian Policy (section 11.6) for NFS safety.
+#       Dovecot: mbox_write_locks = dotlock fcntl
+#       Debian:  mbox_write_locks = fcntl dotlock
+#
 #mbox_read_locks = fcntl
-#mbox_write_locks = dotlock fcntl
+#mbox_write_locks = fcntl dotlock
 
 # Maximum time in seconds to wait for lock (all of them) before aborting.
 #mbox_lock_timeout = 300
--- dovecot-1.2.7.orig/src/master/master-settings.c
+++ dovecot-1.2.7/src/master/master-settings.c
@@ -255,7 +255,7 @@
 	MEMBER(maildir_copy_preserve_filename) FALSE,
 	MEMBER(maildir_very_dirty_syncs) FALSE,
 	MEMBER(mbox_read_locks) "fcntl",
-	MEMBER(mbox_write_locks) "dotlock fcntl",
+	MEMBER(mbox_write_locks) "fcntl dotlock",
 	MEMBER(mbox_lock_timeout) 300,
 	MEMBER(mbox_dotlock_change_timeout) 120,
 	MEMBER(mbox_min_index_size) 0,
@@ -1936,7 +1936,15 @@
 	const char *set_names[5];
 	unsigned int count;
 
-	sets[0] = &default_settings;
+	/* Debian change - the Debian default for mbox_write_lock differs from
+		upstream Dovecot, however we still want 'dovecot -n' to report
+		based on Dovecot defaults to make it clear that the setting is
+		different, so we make a copy of the default_settings and force
+		it to report based on strict Dovecot defaults
+	*/
+	struct settings dovecot_default_settings = default_settings;
+	dovecot_default_settings.mbox_write_locks = "dotlock fcntl";
+	sets[0] = &dovecot_default_settings;
 	sets[1] = set->defaults;
 
 	set_names[0] = NULL;
